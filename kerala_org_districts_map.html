<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerala Organizational Districts Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .info {
            padding: 10px 14px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 8px;
            min-width: 200px;
        }
        .info h4 {
            margin: 0 0 8px;
            color: #333;
            font-size: 16px;
            border-bottom: 2px solid #3388ff;
            padding-bottom: 5px;
        }
        .info p {
            margin: 5px 0;
            color: #555;
        }
        .legend {
            line-height: 20px;
            color: #555;
            max-height: 300px;
            overflow-y: auto;
        }
        .legend h4 {
            margin-bottom: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .legend-item:hover {
            background-color: #f0f0f0;
        }
        .legend i {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            opacity: 0.8;
            border-radius: 3px;
            flex-shrink: 0;
        }
        .legend span {
            font-size: 11px;
        }
        .title-control {
            background: rgba(255,255,255,0.95);
            padding: 12px 18px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .title-control h2 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }
        .title-control p {
            margin: 5px 0 0;
            color: #666;
            font-size: 12px;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px 50px;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
            z-index: 10000;
            text-align: center;
        }
        .loading h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3388ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <h3>Loading Kerala Map...</h3>
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #666;">Processing 30 organizational districts</p>
    </div>
    <div id="map"></div>

    <script>
        // Initialize the map centered on Kerala
        const map = L.map('map').setView([10.5, 76.5], 7);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Color palette for 30 districts
        const colors = [
            '#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00',
            '#ffff33', '#a65628', '#f781bf', '#999999', '#66c2a5',
            '#fc8d62', '#8da0cb', '#e78ac3', '#a6d854', '#ffd92f',
            '#e5c494', '#b3b3b3', '#1b9e77', '#d95f02', '#7570b3',
            '#e7298a', '#66a61e', '#e6ab02', '#a6761d', '#666666',
            '#8dd3c7', '#ffffb3', '#bebada', '#fb8072', '#80b1d3'
        ];

        // Info control
        const info = L.control({ position: 'topright' });
        info.onAdd = function(map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        info.update = function(props) {
            this._div.innerHTML = '<h4>Kerala Organizational Districts</h4>' + 
                (props ? 
                    '<p><strong>' + props.name + '</strong></p>' +
                    '<p>Local Bodies: ' + (props.lbCount || 'N/A') + '</p>'
                    : '<p>Hover over a district</p>');
        };
        info.addTo(map);

        // Title control
        const titleControl = L.control({ position: 'topleft' });
        titleControl.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'title-control');
            div.innerHTML = '<h2>üó∫Ô∏è Kerala Organizational Districts</h2><p>30 Districts | Interactive Map</p>';
            return div;
        };
        titleControl.addTo(map);

        // Store layers for legend interaction
        const districtLayers = {};
        let allBounds = null;

        // GeoJSON data for all 30 organizational districts
        // This will be populated by the Python script
        const districtsData = DISTRICTS_DATA_PLACEHOLDER;

        // Style function
        function getStyle(index) {
            return {
                fillColor: colors[index % colors.length],
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.6
            };
        }

        // Highlight style
        function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 4,
                color: '#333',
                dashArray: '',
                fillOpacity: 0.8
            });
            layer.bringToFront();
            info.update(layer.feature.properties);
        }

        // Reset style
        function resetHighlight(e, index) {
            e.target.setStyle(getStyle(index));
            info.update();
        }

        // Zoom to feature
        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        // Add each district to the map
        districtsData.forEach((district, index) => {
            if (district.geojson && district.geojson.features && district.geojson.features.length > 0) {
                const layer = L.geoJSON(district.geojson, {
                    style: getStyle(index),
                    onEachFeature: function(feature, layer) {
                        feature.properties = {
                            name: district.name,
                            lbCount: district.lbCount
                        };
                        layer.on({
                            mouseover: highlightFeature,
                            mouseout: (e) => resetHighlight(e, index),
                            click: zoomToFeature
                        });
                    }
                }).addTo(map);
                
                districtLayers[district.name] = { layer: layer, color: colors[index % colors.length] };
                
                // Extend bounds
                if (allBounds === null) {
                    allBounds = layer.getBounds();
                } else {
                    allBounds.extend(layer.getBounds());
                }
            }
        });

        // Fit map to Kerala bounds
        if (allBounds) {
            map.fitBounds(allBounds, { padding: [20, 20] });
        }

        // Legend
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<h4>Districts</h4>';
            
            districtsData.forEach((district, index) => {
                if (district.geojson && district.geojson.features && district.geojson.features.length > 0) {
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = '<i style="background:' + colors[index % colors.length] + '"></i><span>' + district.name + '</span>';
                    item.onclick = function() {
                        const layerData = districtLayers[district.name];
                        if (layerData) {
                            map.fitBounds(layerData.layer.getBounds());
                        }
                    };
                    div.appendChild(item);
                }
            });
            
            return div;
        };
        legend.addTo(map);

        // Hide loading
        document.getElementById('loading').style.display = 'none';
    </script>
</body>
</html>
